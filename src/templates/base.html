{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>{%block title%} Tweetme.co{% endblock title%}</title>

    <!-- Bootstrap -->
    <link href="{%static 'css/bootstrap.min.css'%}" rel="stylesheet">

   <!-- ani -->
    <style>
        .grey-color{
          color : grey;
        }
        .red-color{
          color : red;
        }
    </style>
  </head>
  <body>
    
        {%include 'navbar.html'%}
    <div class="container">
        <div class="row">
            
                {% block content%}
        
                {% endblock content %}

        </div>
       
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <script>
        $(document).ready(function(){
          var searchInput =  $("#navbar-search-form ");
          var timeinterval = 600;
          var cleartimer;
          var searchQuery;
  
  
          $("#navbar-search-form ").keyup(function(event){
              
              searchQuery = $(this).val();
              console.log(searchQuery);
             
              clearTimeout(cleartimer);
              cleartimer  = setTimeout(donetyping,timeinterval);
          })
          
          $("#navbar-search-form ").keydown(function(event){
            
            clearTimeout(cleartimer);
            
        })
  
          function donetyping(){
            
            if(searchQuery){
              window.location.href = '/tweet/search/?q=' + searchQuery;
            }
         
          }
        })
      </script>




    {%block scripts%}

    {% endblock scripts%}
    
    
   

    <script>
  ///////////////////////////////////////////////////////////////////////////

function loadTweetContainer(tweetContainerId){


  
  querystring = getParameterByName("q");

  var tweetlist = [];
  var nextTweets;
  var id_for_like = 0;
  var initialUrl ;
  var container;

  if(tweetContainerId){
    container =  $("#"+tweetContainerId);
  }
  else{
    container = "#tweet-container";
  }

  initialUrl = container.attr("data-url") || "/api/tweet";
console.log(initialUrl);






  // hastag related function  

  function updateHashLink(){
    // console.log("dhfjkshj");
     $(".media-body").each(function(data){
       var hashregex =  /(^|\s)#([\w\d-]+)/g
       var userregex =  /(^|\s)@([\w\d-]+)/g
       
       var newhtml = $(this).html().replace(hashregex,"$1<a href='/tags/$2/'>#$2</a>");
        newhtml = newhtml.replace(userregex,"$1@<a href='user/$2/'>$2</a>");
 
       
       $(this).html(newhtml)
       
     })
   }
 
   function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}





  function attachTweet(tweetValue ,retweet, prepend){
   
        var tweetcontent = tweetValue.content;
       
        var tweetuser = tweetValue.user.username;
        var time = tweetValue.date_display
        var url = tweetValue.user.url;

        var likeCount = tweetValue.likes;
        var verb = 'like'

        //var is_retweet = tweetValue.retweet

        var tweetformatedHtml;
        
        if (tweetValue.did_like){
          verb = "unlike";
          }
         
        
        if(retweet && tweetValue.parent){

          var maintweet = tweetValue.parent
          tweetformatedHtml =  `<div class="media">
            
              <div class="media-body">
                Retweet via ${tweetuser}  on ${time} </br>

               
                <h4 class="mt-0"> ${tweetcontent} </h4>
                <p>via   <a href="${maintweet.user.url}"> ${maintweet.user.username} </a> | ${maintweet.date_display} | <a href="tweet/${maintweet.id}"  >View</a></p> <a class='tweet-liked' data-id="${tweetValue.id}" data-likes ="${likeCount}"  href="">${verb}(${likeCount})</a>
                | <a href="tweet/${tweetValue.id}/retweet"> Retweet </a>
                
              </div>
            </div>
            <hr>`



        }
        else{
          tweetformatedHtml= `<div class="media">
            
              <div class="media-body">
               
                <h4 class="mt-0"> ${tweetcontent} </h4>
                <p>via   <a href="${url}"> ${tweetuser} </a>| ${time} | <a href="/tweet/${tweetValue.id}"  >View</a></p> 
                <a class='tweet-liked' data-id="${tweetValue.id}" data-likes ="${likeCount}"  href="">${verb}(${likeCount})</a>
                | <a href="tweet/${tweetValue.id}/retweet"> Retweet </a>
          </div>
        </div>
        <hr>
          `


        }
        
        if(prepend==true){
          container.prepend( tweetformatedHtml) 
        }
        else{
          container.append(tweetformatedHtml) 
         }
   } 

   $(document.body).on('click','.tweet-liked',function(e){
    e.preventDefault();
    var this_ =  $(this)
    var tweet_id = this_.attr('data-id')

    var likes = parseInt(this_.attr('data-likes'));
    
    
    $.ajax(
      {
  
     url:`/api/tweet/${tweet_id}/likes/`,
     method:"GET",
     success: function(data){

      likes = data.count_likes;
  
      if (data.liked){
        this_.text("unlike"+`(${likes})`);
      }
      else{
        
          this_.text("like"+`(${likes})`);
        }
        
  
  
      
  
     },
     error: function(data){
      console.log("error in likes")
      console.log(data)
    }
  
      }
    )
  }
  
  )
    

  
  
  function parsetweet(){

    if (tweetlist==0){
      $("#tweet-container").text("No tweets currently found.")

    }
    else{
      $.each(tweetlist,function(key,value)
{
        tweetValue = value;
        if(value.parent){
        attachTweet(tweetValue,true,false);}
        else{
          attachTweet(tweetValue,false,false)
        }

        }
      )}
    
  }



  function fetchTweets(url){
    console.log(url);
    var fetchurl;
    if(!url){
      fetchurl =initialUrl ;
    }
    else{
      fetchurl = url;
    }
    $.ajax(
  {
    url: fetchurl,
    
    data:{
      "q":querystring
    },
    method: "GET",
   
    success: function(data){
      tweetlist = data.results;
      nextTweets = data.next;
      parsetweet();
      updateHashLink();
      
     
}
}
)

  }
fetchTweets();



$(".loadmore").click(function(event){
  if(nextTweets){
    fetchTweets(nextTweets);
  }
  else{
    
  }
 
})

var charStart = 140;
var charCurrent = 0;
$("#tweet-form").append(`<span id="tweetcharleft"> ${charStart} </span>`)

$("#tweet-form textarea").keyup(function(event){
  var value = $(this).val();
  var len = value.length;
  charCurrent = charStart-len;
  $("#tweetcharleft").text(charCurrent);
  

  if(charCurrent>0){
    $("#tweetcharleft").removeClass("grey-color");
    $("#tweetcharleft").removeClass("red-color");

  }
  else if(charCurrent==0){
    $("#tweetcharleft").removeClass("red-color");
    $("#tweetcharleft").addClass("grey-color");

  }

  
  else if(charCurrent<0){
    $("#tweetcharleft").removeClass("grey-color");
    $("#tweetcharleft").addClass("red-color");

  }
    

})









  $("#tweet-form").submit(function(event){

    event.preventDefault();
    var this_  = $(this);
    var formData = this_.serialize()
    console.log(formData);
    console.log(this_);

    if(charCurrent>0){
      $.ajax(
        {
          url: "/api/tweet/create/",
          
          data: formData,
          method: "POST",
         
          success: function(data){
            tweetlist = data;
            
            attachTweet(tweetlist,false,true);
            
            this_.find("input[type=text], textarea").val("")
            updateHashLink();
          },
  
          error: function(data){
            console.log("erro");
            console.log(data.statusText);
            console.log(data.status);
  
          }
         
      }
      )

    }
    else{
      console.log("size limit exceede");
    }

  
})

}
 
    </script>



    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{static 'js/bootstrap.min.js'}"></script>
  </body>
</html>